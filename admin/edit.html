<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Edit Project — Admin</title>
    <link rel="icon" type="image/png" href="/images/favicon.png" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --sidebar-w: 240px;
            --accent: #ff8400;
            --bg-main: #f8f7f5;
            --bg-sidebar: #282828;
            --border: #e5e7eb;
            --text-dark: #282828;
            --text-muted: #6b7280;
        }

        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            background: var(--bg-main);
            color: var(--text-dark);
            min-height: 100vh;
        }

        /* ── Sidebar (same as dashboard) ── */
        .sidebar {
            position: fixed;
            top: 0; left: 0; bottom: 0;
            width: var(--sidebar-w);
            background: var(--bg-sidebar);
            display: flex;
            flex-direction: column;
            z-index: 50;
            border-right: 1px solid rgba(255,255,255,0.05);
        }

        .sidebar-logo { padding: 28px 24px 24px; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .sidebar-logo img { height: 26px; filter: brightness(0) invert(1); display: block; }
        .sidebar-label { font-size: 9px; font-family: 'Courier New', monospace; color: rgba(255,255,255,0.25); letter-spacing: 0.14em; text-transform: uppercase; margin-top: 8px; }

        .sidebar-nav { padding: 20px 12px; flex: 1; }

        .nav-item {
            display: flex; align-items: center; gap: 10px;
            padding: 9px 12px;
            font-size: 13px; font-weight: 500;
            color: rgba(255,255,255,0.5);
            text-decoration: none;
            transition: color 0.15s, background 0.15s;
        }
        .nav-item:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .nav-item.active { color: #fff; background: rgba(255,132,0,0.12); border-left: 2px solid var(--accent); padding-left: 10px; }
        .nav-item .material-symbols-outlined { font-size: 18px; }

        .sidebar-footer { padding: 16px 16px 20px; border-top: 1px solid rgba(255,255,255,0.06); }
        .user-email { font-size: 11px; color: rgba(255,255,255,0.35); margin-bottom: 12px; word-break: break-all; font-family: 'Courier New', monospace; }
        .signout-btn {
            display: flex; align-items: center; gap: 8px;
            font-size: 12px; color: rgba(255,255,255,0.4);
            background: none; border: 1px solid rgba(255,255,255,0.08);
            padding: 8px 12px; cursor: pointer; width: 100%;
            font-family: 'Inter', sans-serif; transition: color 0.15s, border-color 0.15s;
        }
        .signout-btn:hover { color: rgba(255,255,255,0.8); border-color: rgba(255,255,255,0.2); }
        .signout-btn .material-symbols-outlined { font-size: 16px; }

        /* ── Main ── */
        .main { margin-left: var(--sidebar-w); min-height: 100vh; display: flex; flex-direction: column; }

        .topbar {
            display: flex; align-items: center; justify-content: space-between;
            padding: 20px 32px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-main);
            position: sticky; top: 0; z-index: 10;
        }

        .topbar-left { display: flex; align-items: center; gap: 12px; }

        .back-btn {
            display: flex; align-items: center; gap: 6px;
            font-size: 13px; color: var(--text-muted);
            text-decoration: none; transition: color 0.15s;
        }
        .back-btn:hover { color: var(--text-dark); }
        .back-btn .material-symbols-outlined { font-size: 18px; }

        .topbar-divider { width: 1px; height: 20px; background: var(--border); }

        .topbar-title { font-size: 15px; font-weight: 600; color: var(--text-dark); }

        .topbar-actions { display: flex; gap: 8px; align-items: center; }

        .btn-primary {
            display: inline-flex; align-items: center; gap: 6px;
            background: var(--accent); color: #fff; border: none;
            padding: 10px 18px; font-size: 13px; font-weight: 600;
            font-family: 'Inter', sans-serif; cursor: pointer;
            transition: background 0.15s;
        }
        .btn-primary:hover { background: #e07200; }
        .btn-primary:disabled { background: #fbbf7a; cursor: not-allowed; }

        .btn-danger {
            display: inline-flex; align-items: center; gap: 6px;
            background: #fff; color: #dc2626; border: 1px solid #fca5a5;
            padding: 9px 16px; font-size: 13px; font-weight: 500;
            font-family: 'Inter', sans-serif; cursor: pointer;
            transition: background 0.15s, border-color 0.15s;
        }
        .btn-danger:hover { background: #fff1f0; border-color: #f87171; }
        .btn-danger .material-symbols-outlined { font-size: 16px; }

        /* ── Form ── */
        .content { padding: 32px; max-width: 900px; }

        .form-section {
            background: #fff;
            border: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .section-header {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .section-header .material-symbols-outlined { font-size: 16px; }

        .section-body { padding: 24px; }

        .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .field-row.full { grid-template-columns: 1fr; }
        .field-row:last-child { margin-bottom: 0; }

        .field { }

        .field label {
            display: block;
            font-size: 10px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 8px;
        }

        .field input, .field textarea, .field select {
            width: 100%;
            background: #fafafa;
            border: 1px solid var(--border);
            padding: 10px 12px;
            font-size: 13px; color: var(--text-dark);
            font-family: 'Inter', sans-serif;
            outline: none; transition: border-color 0.15s, background 0.15s;
        }
        .field input:focus, .field textarea:focus, .field select:focus {
            border-color: var(--accent); background: #fff;
        }
        .field textarea { resize: vertical; min-height: 100px; }
        .field-hint { font-size: 11px; color: var(--text-muted); margin-top: 5px; }

        /* Icon picker button */
        .icon-picker-btn {
            display: flex; align-items: center; gap: 10px;
            padding: 9px 14px; background: #fafafa;
            border: 1px solid var(--border); cursor: pointer;
            font-size: 13px; color: var(--text-dark);
            font-family: 'Inter', sans-serif; transition: border-color 0.15s, background 0.15s;
            width: 100%; text-align: left;
        }
        .icon-picker-btn:hover { border-color: var(--accent); background: #fff; }
        .icon-picker-btn .material-symbols-outlined { font-size: 20px; flex-shrink: 0; }
        .icon-picker-btn-label { flex: 1; font-family: 'Courier New', monospace; font-size: 12px; color: var(--text-muted); }
        .icon-picker-btn-caret { font-size: 16px !important; color: #9ca3af; }

        /* Icon picker modal */
        .icon-modal-overlay {
            display: none; position: fixed; inset: 0;
            background: rgba(0,0,0,0.5); z-index: 200;
            align-items: center; justify-content: center;
        }
        .icon-modal-overlay.open { display: flex; }
        .icon-modal {
            background: #fff; width: 580px; max-width: 95vw;
            max-height: 80vh; display: flex; flex-direction: column;
            border: 1px solid var(--border);
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        .icon-modal-header {
            padding: 16px 20px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; gap: 12px;
        }
        .icon-modal-header input {
            flex: 1; border: 1px solid var(--border); background: #fafafa;
            padding: 8px 12px; font-size: 13px; font-family: 'Inter', sans-serif;
            outline: none; transition: border-color 0.15s;
        }
        .icon-modal-header input:focus { border-color: var(--accent); background: #fff; }
        .icon-modal-close {
            background: none; border: none; cursor: pointer;
            color: var(--text-muted); padding: 4px; line-height: 1;
            transition: color 0.15s;
        }
        .icon-modal-close:hover { color: var(--text-dark); }
        .icon-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(72px, 1fr));
            gap: 4px; padding: 16px; overflow-y: auto; flex: 1;
        }
        .icon-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 4px; padding: 10px 6px; cursor: pointer;
            border: 1px solid transparent; transition: border-color 0.12s, background 0.12s;
        }
        .icon-item:hover { border-color: var(--accent); background: #fff8f0; }
        .icon-item.selected { border-color: var(--accent); background: #fff3e0; }
        .icon-item .material-symbols-outlined { font-size: 22px; color: var(--text-dark); }
        .icon-item span:last-child { font-size: 9px; color: var(--text-muted); text-align: center; font-family: 'Courier New', monospace; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; width: 100%; }

        /* Image upload */
        .upload-zone {
            border: 2px dashed var(--border);
            background: #fafafa;
            padding: 32px 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background 0.2s;
        }
        .upload-zone:hover, .upload-zone.drag-over { border-color: var(--accent); background: #fff8f0; }
        .upload-zone input[type=file] { display: none; }
        .upload-zone .material-symbols-outlined { font-size: 28px; color: #d1d5db; display: block; margin: 0 auto 8px; }
        .upload-zone p { font-size: 13px; color: var(--text-muted); }
        .upload-zone span { font-size: 11px; color: #9ca3af; display: block; margin-top: 4px; }

        .image-preview-wrap { margin-top: 16px; }
        .image-preview {
            position: relative;
            display: inline-block;
            margin: 6px;
        }
        .image-preview img {
            width: 120px; height: 80px;
            object-fit: cover;
            border: 1px solid var(--border);
            display: block;
        }
        .image-preview-remove {
            position: absolute;
            top: 4px; right: 4px;
            width: 20px; height: 20px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 12px;
            transition: background 0.15s;
        }
        .image-preview-remove:hover { background: #dc2626; }
        .image-preview-remove .material-symbols-outlined { font-size: 14px; }

        .upload-progress {
            display: none;
            font-size: 12px; color: var(--accent);
            margin-top: 8px;
            font-family: 'Courier New', monospace;
        }

        /* Toggle row */
        .toggle-row { display: flex; align-items: center; justify-content: space-between; }
        .toggle-label { font-size: 13px; color: var(--text-dark); }
        .toggle-hint { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

        .toggle {
            position: relative; width: 44px; height: 24px; cursor: pointer; flex-shrink: 0;
        }
        .toggle input { opacity: 0; width: 0; height: 0; position: absolute; }
        .toggle-track { position: absolute; inset: 0; background: #e5e7eb; transition: background 0.2s; border-radius: 12px; }
        .toggle input:checked + .toggle-track { background: var(--accent); }
        .toggle-thumb { position: absolute; top: 4px; left: 4px; width: 16px; height: 16px; background: #fff; border-radius: 50%; transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .toggle input:checked ~ .toggle-thumb { transform: translateX(20px); }

        /* Error / Success */
        .alert { padding: 12px 16px; font-size: 13px; margin-bottom: 20px; }
        .alert-error { background: #fff1f0; border: 1px solid #fca5a5; color: #b91c1c; }
        .alert-success { background: #f0fdf4; border: 1px solid #86efac; color: #15803d; }

        /* ── Toast ── */
        #toast {
            position: fixed; bottom: 24px; right: 24px;
            background: var(--text-dark); color: #fff;
            font-size: 13px; padding: 12px 20px;
            z-index: 100; opacity: 0; transform: translateY(8px);
            transition: opacity 0.2s, transform 0.2s; pointer-events: none;
        }
        #toast.show { opacity: 1; transform: translateY(0); }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <img src="../images/logo.png" alt="Thinking In Steps" />
            <div class="sidebar-label">Admin</div>
        </div>
        <nav class="sidebar-nav">
            <a class="nav-item active" href="dashboard.html">
                <span class="material-symbols-outlined">grid_view</span>
                Projects
            </a>
            <a class="nav-item" href="../index.html" target="_blank">
                <span class="material-symbols-outlined">open_in_new</span>
                View Site
            </a>
        </nav>
        <div class="sidebar-footer">
            <div class="user-email" id="user-email">—</div>
            <button class="signout-btn" id="signout-btn">
                <span class="material-symbols-outlined">logout</span>
                Sign Out
            </button>
        </div>
    </aside>

    <!-- Main -->
    <main class="main">
        <div class="topbar">
            <div class="topbar-left">
                <a href="dashboard.html" class="back-btn">
                    <span class="material-symbols-outlined">arrow_back</span>
                    Back
                </a>
                <div class="topbar-divider"></div>
                <div class="topbar-title" id="page-title">New Project</div>
            </div>
            <div class="topbar-actions">
                <button class="btn-danger" id="delete-btn" style="display:none;">
                    <span class="material-symbols-outlined">delete</span>
                    Delete
                </button>
                <button class="btn-primary" id="save-btn">
                    <span class="material-symbols-outlined">save</span>
                    Save Project
                </button>
            </div>
        </div>

        <div class="content">
            <div id="alert" class="alert" style="display:none;"></div>

            <form id="project-form">

                <!-- Basic Info -->
                <div class="form-section">
                    <div class="section-header">
                        <span class="material-symbols-outlined">info</span>
                        Basic Info
                    </div>
                    <div class="section-body">
                        <div class="field-row">
                            <div class="field">
                                <label for="f-title">Title *</label>
                                <input type="text" id="f-title" placeholder="e.g. TaskLayer" required />
                            </div>
                            <div class="field">
                                <label for="f-slug">Slug *</label>
                                <input type="text" id="f-slug" placeholder="e.g. tasklayer" required pattern="[a-z0-9\-]+" />
                                <div class="field-hint">URL-safe identifier. Auto-generated from title.</div>
                            </div>
                        </div>
                        <div class="field-row">
                            <div class="field">
                                <label>Icon</label>
                                <input type="hidden" id="f-icon" value="code" />
                                <button type="button" class="icon-picker-btn" id="icon-picker-btn">
                                    <span class="material-symbols-outlined" id="icon-preview-symbol">code</span>
                                    <span class="icon-picker-btn-label" id="icon-picker-label">code</span>
                                    <span class="material-symbols-outlined icon-picker-btn-caret">expand_more</span>
                                </button>
                            </div>
                        </div>
                        <div class="field-row full">
                            <div class="field">
                                <label for="f-description">Description</label>
                                <textarea id="f-description" placeholder="Describe what this project does and why it exists…" rows="4"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tags & Metadata -->
                <div class="form-section">
                    <div class="section-header">
                        <span class="material-symbols-outlined">label</span>
                        Tags & Metadata
                    </div>
                    <div class="section-body">
                        <div class="field-row">
                            <div class="field">
                                <label for="f-tags">Tags</label>
                                <input type="text" id="f-tags" placeholder="React, Go, Rust (comma-separated)" />
                                <div class="field-hint">Comma-separated tech stack labels.</div>
                            </div>
                            <div class="field">
                                <label for="f-version">Version</label>
                                <input type="text" id="f-version" placeholder="e.g. V 2.4.0" />
                            </div>
                        </div>
                        <div class="field-row">
                            <div class="field">
                                <label for="f-status">Status Label</label>
                                <select id="f-status">
                                    <option value="ACTIVE">ACTIVE</option>
                                    <option value="BETA">BETA</option>
                                    <option value="ARCHIVED">ARCHIVED</option>
                                    <option value="STEALTH">STEALTH</option>
                                </select>
                            </div>
                            <div class="field">
                                <label for="f-order">Sort Order</label>
                                <input type="number" id="f-order" value="0" min="0" />
                                <div class="field-hint">Lower numbers appear first.</div>
                            </div>
                        </div>

                        <!-- Build progress slider — shown on STEALTH cards -->
                        <div class="field-row full" id="progress-row" style="display:none;">
                            <div class="field">
                                <label for="f-progress">
                                    Build Progress
                                    <span id="progress-display" style="font-size:11px; font-family:'Courier New',monospace; color:var(--accent); margin-left:8px; font-weight:700;">0%</span>
                                </label>
                                <input type="range" id="f-progress" min="0" max="100" value="0"
                                    style="width:100%; accent-color:var(--accent); height:4px; cursor:pointer; margin-top:6px;" />
                                <div class="field-hint">Displayed on the card when status is STEALTH.</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Links -->
                <div class="form-section">
                    <div class="section-header">
                        <span class="material-symbols-outlined">link</span>
                        Links
                    </div>
                    <div class="section-body">
                        <div class="field-row">
                            <div class="field">
                                <label for="f-link-text">Link Button Text</label>
                                <input type="text" id="f-link-text" placeholder="e.g. View Live, Join Beta" />
                                <div class="field-hint">Leave blank to hide the link button.</div>
                            </div>
                            <div class="field">
                                <label for="f-link-href">Link URL</label>
                                <input type="url" id="f-link-href" placeholder="https://…" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Media -->
                <div class="form-section">
                    <div class="section-header">
                        <span class="material-symbols-outlined">image</span>
                        Media
                    </div>
                    <div class="section-body">
                        <!-- Cover image -->
                        <div class="field" style="margin-bottom: 28px;">
                            <label>Cover Image</label>
                            <div class="upload-zone" id="cover-zone">
                                <input type="file" id="cover-file" accept="image/*" />
                                <span class="material-symbols-outlined">cloud_upload</span>
                                <p>Click or drag to upload cover image</p>
                                <span>PNG, JPG, WebP — max 10MB</span>
                            </div>
                            <div class="upload-progress" id="cover-progress">Uploading…</div>
                            <div id="cover-preview-wrap" class="image-preview-wrap" style="display:none;">
                                <div class="image-preview">
                                    <img id="cover-preview-img" src="" alt="Cover" />
                                    <button type="button" class="image-preview-remove" id="cover-remove">
                                        <span class="material-symbols-outlined">close</span>
                                    </button>
                                </div>
                            </div>
                            <input type="hidden" id="f-cover-url" />
                        </div>

                        <!-- Gallery images -->
                        <div class="field">
                            <label>Gallery Images</label>
                            <div class="upload-zone" id="gallery-zone">
                                <input type="file" id="gallery-file" accept="image/*" multiple />
                                <span class="material-symbols-outlined">photo_library</span>
                                <p>Click or drag to add gallery images</p>
                                <span>Multiple files supported</span>
                            </div>
                            <div class="upload-progress" id="gallery-progress">Uploading…</div>
                            <div id="gallery-preview-wrap" class="image-preview-wrap"></div>
                        </div>
                    </div>
                </div>

                <!-- Settings -->
                <div class="form-section">
                    <div class="section-header">
                        <span class="material-symbols-outlined">settings</span>
                        Settings
                    </div>
                    <div class="section-body">
                        <div class="toggle-row">
                            <div>
                                <div class="toggle-label">Show on public site</div>
                                <div class="toggle-hint">When off, this project is hidden from visitors but saved in your admin.</div>
                            </div>
                            <label class="toggle">
                                <input type="checkbox" id="f-visible" checked />
                                <div class="toggle-track"></div>
                                <div class="toggle-thumb"></div>
                            </label>
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </main>

    <div id="toast"></div>

    <!-- Icon Picker Modal -->
    <div class="icon-modal-overlay" id="icon-modal-overlay">
        <div class="icon-modal">
            <div class="icon-modal-header">
                <input type="text" id="icon-search" placeholder="Search icons…" autocomplete="off" />
                <button class="icon-modal-close" id="icon-modal-close">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="icon-grid" id="icon-grid"></div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        import { SUPABASE_URL, SUPABASE_ANON_KEY } from '../js/supabase-config.js';

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ── Auth guard ────────────────────────────────────────────────────────
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { window.location.href = 'login.html'; }

        document.getElementById('user-email').textContent = session?.user?.email || '—';
        document.getElementById('signout-btn').addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        });

        // ── State ─────────────────────────────────────────────────────────────
        // Read ID from URL query string first, fall back to sessionStorage (set by dashboard)
        const urlId = new URLSearchParams(window.location.search).get('id');
        const storageId = sessionStorage.getItem('editProjectId');
        if (storageId) sessionStorage.removeItem('editProjectId');
        const editId = urlId || storageId;
        const isEdit = !!editId;

        let galleryUrls = []; // Array of stored URLs

        // ── Elements ──────────────────────────────────────────────────────────
        const pageTitle = document.getElementById('page-title');
        const saveBtn = document.getElementById('save-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const alertBox = document.getElementById('alert');

        if (isEdit) {
            pageTitle.textContent = 'Edit Project';
            deleteBtn.style.display = 'inline-flex';
        }

        // ── Toast ─────────────────────────────────────────────────────────────
        function showToast(msg, duration = 3000) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), duration);
        }

        function showAlert(msg, type = 'error') {
            alertBox.textContent = msg;
            alertBox.className = `alert alert-${type}`;
            alertBox.style.display = 'block';
            alertBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // ── Build progress slider ─────────────────────────────────────────────
        const progressRow = document.getElementById('progress-row');
        const progressSlider = document.getElementById('f-progress');
        const progressDisplay = document.getElementById('progress-display');
        const statusSelect = document.getElementById('f-status');

        function syncProgressVisibility() {
            progressRow.style.display = statusSelect.value === 'STEALTH' ? '' : 'none';
        }

        progressSlider.addEventListener('input', () => {
            progressDisplay.textContent = progressSlider.value + '%';
        });

        statusSelect.addEventListener('change', syncProgressVisibility);
        syncProgressVisibility();

        // ── Icon picker ───────────────────────────────────────────────────────
        let ALL_ICONS = null; // loaded once from Google

        const iconInput = document.getElementById('f-icon');
        const iconPreviewSymbol = document.getElementById('icon-preview-symbol');
        const iconPickerBtn = document.getElementById('icon-picker-btn');
        const iconPickerLabel = document.getElementById('icon-picker-label');
        const iconModalOverlay = document.getElementById('icon-modal-overlay');
        const iconModalClose = document.getElementById('icon-modal-close');
        const iconSearch = document.getElementById('icon-search');
        const iconGrid = document.getElementById('icon-grid');

        function setIcon(name) {
            iconInput.value = name;
            iconPreviewSymbol.textContent = name;
            iconPickerLabel.textContent = name;
        }

        async function loadIcons() {
            if (ALL_ICONS) return ALL_ICONS;
            iconGrid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:32px;font-size:12px;color:#9ca3af;font-family:monospace;">Loading icons…</div>';
            try {
                // Fetch the official Material Symbols Outlined codepoints file from GitHub.
                // This is CORS-friendly and contains every icon name in the font.
                const res = await fetch('https://raw.githubusercontent.com/google/material-design-icons/master/variablefont/MaterialSymbolsOutlined%5BFILL%2CGRAD%2Copsz%2Cwght%5D.codepoints');
                const text = await res.text();
                ALL_ICONS = text.trim().split('\n')
                    .map(line => line.split(' ')[0])          // icon_name codepoint → icon_name
                    .filter(n => n && !/^\d/.test(n));        // drop blank lines and digit-leading names
            } catch {
                // Hard fallback with a broad set of common icons
                ALL_ICONS = ['abc','accessibility','account_balance','account_circle','account_tree','add','add_circle','adjust','agriculture','alarm','analytics','anchor','android','announcement','api','apps','archive','arrow_back','arrow_forward','article','assignment','assistant','audio_file','auto_awesome','backup','badge','bar_chart','bluetooth','bolt','book','bookmarks','brightness_5','brush','bubble_chart','bug_report','build','business','cable','calendar_today','call','camera','campaign','cancel','category','chat','check_circle','chevron_right','cloud','cloud_upload','code','coffee','comment','computer','contacts','content_copy','credit_card','dashboard','database','date_range','description','design_services','developer_mode','devices','dns','done','done_all','download','draw','eco','edit','email','emoji_events','explore','extension','favorite','file_copy','filter_list','flag','flash_on','folder','folder_open','forum','functions','grade','grid_view','group','groups','health_and_safety','history','home','hub','image','inbox','insights','integration_instructions','inventory_2','key','label','language','laptop','leaderboard','local_shipping','location_on','lock','mail','manage_accounts','map','memory','message','mic','military_tech','monitor','navigation','new_releases','note','notifications','palette','payments','person','person_add','phone_android','photo_camera','photo_library','pie_chart','place','play_arrow','power','psychology','public','receipt_long','recycling','rocket_launch','savings','schedule','science','search','security','settings','shield','shopping_cart','smart_toy','smartphone','sort','star','stars','storage','store','storefront','table_chart','task_alt','terminal','timer','trending_up','tune','tv','usb','verified','verified_user','video_library','videocam','view_list','view_module','vpn_key','wallet','warehouse','watch','web','wifi','workspace_premium'];
            }
            return ALL_ICONS;
        }

        function renderIconGrid(icons, filter = '') {
            const q = filter.toLowerCase().replace(/\s+/g, '_');
            const filtered = q ? icons.filter(i => i.includes(q)) : icons;
            const current = iconInput.value;
            // Limit to 500 shown at once for performance; search narrows it down
            const display = filtered.slice(0, 500);
            const total = filtered.length;
            iconGrid.innerHTML = display.map(name => `
                <div class="icon-item${name === current ? ' selected' : ''}" data-icon="${name}" title="${name}">
                    <span class="material-symbols-outlined">${name}</span>
                    <span>${name.replace(/_/g, ' ')}</span>
                </div>
            `).join('') + (total > 500 ? `<div style="grid-column:1/-1;text-align:center;padding:12px;font-size:11px;color:#9ca3af;font-family:monospace;">Showing 500 of ${total} — search to narrow results</div>` : '');
            iconGrid.querySelectorAll('.icon-item').forEach(el => {
                el.addEventListener('click', () => {
                    setIcon(el.dataset.icon);
                    closeIconModal();
                });
            });
        }

        async function openIconModal() {
            iconModalOverlay.classList.add('open');
            iconSearch.value = '';
            const icons = await loadIcons();
            renderIconGrid(icons);
            iconSearch.focus();
        }

        function closeIconModal() {
            iconModalOverlay.classList.remove('open');
        }

        iconPickerBtn.addEventListener('click', openIconModal);
        iconModalClose.addEventListener('click', closeIconModal);
        iconModalOverlay.addEventListener('click', e => { if (e.target === iconModalOverlay) closeIconModal(); });
        iconSearch.addEventListener('input', async () => {
            const icons = await loadIcons();
            renderIconGrid(icons, iconSearch.value);
        });
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeIconModal(); });

        // ── Slug auto-generation ──────────────────────────────────────────────
        const titleInput = document.getElementById('f-title');
        const slugInput = document.getElementById('f-slug');
        let slugManuallyEdited = false;

        titleInput.addEventListener('input', () => {
            if (!slugManuallyEdited) {
                slugInput.value = titleInput.value.toLowerCase()
                    .replace(/[^a-z0-9\s-]/g, '')
                    .replace(/\s+/g, '-')
                    .replace(/-+/g, '-');
            }
        });

        slugInput.addEventListener('input', () => { slugManuallyEdited = true; });

        // ── Image upload helpers ───────────────────────────────────────────────
        function getSlug() {
            return slugInput.value.trim() || 'project';
        }

        async function uploadImage(file, prefix) {
            const ext = file.name.split('.').pop();
            const filename = `${prefix}-${Date.now()}.${ext}`;
            const path = `${getSlug()}/${filename}`;
            const { error } = await supabase.storage
                .from('project-images')
                .upload(path, file, { upsert: true });
            if (error) throw error;
            const { data: { publicUrl } } = supabase.storage
                .from('project-images')
                .getPublicUrl(path);
            return publicUrl;
        }

        async function deleteStorageUrl(url) {
            // Extract path from URL: .../object/public/project-images/{path}
            const marker = '/project-images/';
            const idx = url.indexOf(marker);
            if (idx === -1) return;
            const path = url.slice(idx + marker.length);
            await supabase.storage.from('project-images').remove([path]);
        }

        // ── Cover image ───────────────────────────────────────────────────────
        const coverZone = document.getElementById('cover-zone');
        const coverFile = document.getElementById('cover-file');
        const coverProgress = document.getElementById('cover-progress');
        const coverPreviewWrap = document.getElementById('cover-preview-wrap');
        const coverPreviewImg = document.getElementById('cover-preview-img');
        const coverUrlInput = document.getElementById('f-cover-url');
        const coverRemove = document.getElementById('cover-remove');

        function showCoverPreview(url) {
            coverPreviewImg.src = url;
            coverPreviewWrap.style.display = 'block';
            coverZone.style.display = 'none';
            coverUrlInput.value = url;
        }

        function clearCoverPreview() {
            coverPreviewImg.src = '';
            coverPreviewWrap.style.display = 'none';
            coverZone.style.display = 'block';
            coverUrlInput.value = '';
        }

        coverZone.addEventListener('click', () => coverFile.click());
        coverZone.addEventListener('dragover', e => { e.preventDefault(); coverZone.classList.add('drag-over'); });
        coverZone.addEventListener('dragleave', () => coverZone.classList.remove('drag-over'));
        coverZone.addEventListener('drop', async e => {
            e.preventDefault();
            coverZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file) await handleCoverUpload(file);
        });

        coverFile.addEventListener('change', async () => {
            if (coverFile.files[0]) await handleCoverUpload(coverFile.files[0]);
        });

        async function handleCoverUpload(file) {
            coverProgress.style.display = 'block';
            try {
                const url = await uploadImage(file, 'cover');
                showCoverPreview(url);
                showToast('Cover image uploaded.');
            } catch (err) {
                showToast('Upload failed: ' + err.message);
            }
            coverProgress.style.display = 'none';
        }

        coverRemove.addEventListener('click', async () => {
            const url = coverUrlInput.value;
            if (url) await deleteStorageUrl(url);
            clearCoverPreview();
        });

        // ── Gallery images ────────────────────────────────────────────────────
        const galleryZone = document.getElementById('gallery-zone');
        const galleryFile = document.getElementById('gallery-file');
        const galleryProgress = document.getElementById('gallery-progress');
        const galleryPreviewWrap = document.getElementById('gallery-preview-wrap');

        function renderGalleryPreviews() {
            galleryPreviewWrap.innerHTML = galleryUrls.map((url, i) => `
                <div class="image-preview">
                    <img src="${url}" alt="Gallery image ${i + 1}" />
                    <button type="button" class="image-preview-remove" data-gallery-index="${i}">
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
            `).join('');

            galleryPreviewWrap.querySelectorAll('[data-gallery-index]').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const idx = parseInt(btn.dataset.galleryIndex, 10);
                    const url = galleryUrls[idx];
                    if (url) await deleteStorageUrl(url);
                    galleryUrls.splice(idx, 1);
                    renderGalleryPreviews();
                });
            });
        }

        galleryZone.addEventListener('click', () => galleryFile.click());
        galleryZone.addEventListener('dragover', e => { e.preventDefault(); galleryZone.classList.add('drag-over'); });
        galleryZone.addEventListener('dragleave', () => galleryZone.classList.remove('drag-over'));
        galleryZone.addEventListener('drop', async e => {
            e.preventDefault();
            galleryZone.classList.remove('drag-over');
            await handleGalleryUpload(Array.from(e.dataTransfer.files));
        });

        galleryFile.addEventListener('change', async () => {
            await handleGalleryUpload(Array.from(galleryFile.files));
        });

        async function handleGalleryUpload(files) {
            galleryProgress.style.display = 'block';
            for (const file of files) {
                try {
                    const url = await uploadImage(file, 'gallery');
                    galleryUrls.push(url);
                } catch (err) {
                    showToast('Upload failed: ' + err.message);
                }
            }
            galleryProgress.style.display = 'none';
            renderGalleryPreviews();
            showToast(`${files.length} image${files.length > 1 ? 's' : ''} uploaded.`);
        }

        // ── Load existing project (edit mode) ────────────────────────────────
        if (isEdit) {
            const { data: proj, error } = await supabase
                .from('projects')
                .select('*')
                .eq('id', editId)
                .single();

            if (error || !proj) {
                showAlert('Project not found.');
            } else {
                pageTitle.textContent = `Edit: ${proj.title}`;
                document.getElementById('f-title').value = proj.title || '';
                document.getElementById('f-slug').value = proj.slug || '';
                setIcon(proj.icon || 'code');
                document.getElementById('f-description').value = proj.description || '';
                document.getElementById('f-tags').value = (proj.tags || []).join(', ');
                document.getElementById('f-version').value = proj.version || '';
                document.getElementById('f-status').value = proj.status_label || 'ACTIVE';
                document.getElementById('f-link-text').value = proj.link_text || '';
                document.getElementById('f-link-href').value = proj.link_href || '';
                document.getElementById('f-order').value = proj.sort_order ?? 0;
                document.getElementById('f-visible').checked = proj.is_visible !== false;
                progressSlider.value = proj.build_progress ?? 0;
                progressDisplay.textContent = (proj.build_progress ?? 0) + '%';
                syncProgressVisibility();
                slugManuallyEdited = true;

                if (proj.cover_url) showCoverPreview(proj.cover_url);
                if (proj.gallery_urls && proj.gallery_urls.length > 0) {
                    galleryUrls = [...proj.gallery_urls];
                    renderGalleryPreviews();
                }
            }
        }

        // ── Save ──────────────────────────────────────────────────────────────
        saveBtn.addEventListener('click', async () => {
            alertBox.style.display = 'none';
            const title = document.getElementById('f-title').value.trim();
            const slug = document.getElementById('f-slug').value.trim();

            if (!title) { showAlert('Title is required.'); return; }
            if (!slug) { showAlert('Slug is required.'); return; }
            if (!/^[a-z0-9-]+$/.test(slug)) { showAlert('Slug may only contain lowercase letters, numbers, and hyphens.'); return; }

            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving…';

            const payload = {
                title,
                slug,
                icon: document.getElementById('f-icon').value.trim() || 'code',
                description: document.getElementById('f-description').value.trim(),
                tags: document.getElementById('f-tags').value
                    .split(',').map(t => t.trim()).filter(Boolean),
                version: document.getElementById('f-version').value.trim(),
                status_label: document.getElementById('f-status').value,
                link_text: document.getElementById('f-link-text').value.trim() || null,
                link_href: document.getElementById('f-link-href').value.trim() || null,
                cover_url: document.getElementById('f-cover-url').value || null,
                gallery_urls: galleryUrls,
                sort_order: parseInt(document.getElementById('f-order').value, 10) || 0,
                is_visible: document.getElementById('f-visible').checked,
                build_progress: statusSelect.value === 'STEALTH' ? (parseInt(progressSlider.value, 10) || 0) : 0,
            };

            let error;
            if (isEdit) {
                const result = await supabase.from('projects').update(payload).eq('id', editId).select();
                error = result.error;
                if (!error && (!result.data || result.data.length === 0)) {
                    error = { message: 'Update was blocked — your session may have expired. Please sign out and sign back in.' };
                }
            } else {
                ({ error } = await supabase.from('projects').insert([payload]));
            }

            saveBtn.disabled = false;
            saveBtn.innerHTML = '<span class="material-symbols-outlined">save</span> Save Project';

            if (error) {
                showAlert(`Save failed: ${error.message}`);
            } else {
                showToast(isEdit ? 'Project updated.' : 'Project created.');
                setTimeout(() => { window.location.href = 'dashboard.html'; }, 900);
            }
        });

        // ── Delete ────────────────────────────────────────────────────────────
        deleteBtn.addEventListener('click', async () => {
            if (!confirm('Delete this project permanently? Images in storage will not be deleted automatically.')) return;
            const { error } = await supabase.from('projects').delete().eq('id', editId);
            if (error) { showAlert(`Delete failed: ${error.message}`); return; }
            showToast('Project deleted.');
            setTimeout(() => { window.location.href = 'dashboard.html'; }, 900);
        });
    </script>
</body>
</html>
